<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learn Vue.js</title>
    <script src="https://unpkg.com/vue@next"></script>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      const { ref, reactive, computed } = Vue;

      const ListBook = {
        props: ['endpoint'],
        setup(props, context) {
          const books = reactive([]);
          const keyword = ref('');
          const sortType = ref('');
          const loading = ref(false);

          const fetchBooks = () => {
            loading.value = true;
            fetch(props.endpoint)
              .then((response) => {
                return response.json();
              })
              .then((data) => {
                books.push(...data);
              })
              .finally(() => {
                loading.value = false;
              });
          };

          fetchBooks();
          const searchBook = (books, keyword) => {
            return books.filter((book) => {
              return keyword === '' ? true : book.title.search(keyword) >= 0;
            });
          };

          const sortBook = (books, sortType = 'asc') => {
            return books.sort((a, b) => {
              if (sortType === 'asc') {
                return a.title.localeCompare(b.title);
              } else if (sortType === 'desc') {
                return b.title.localeCompare(a.title);
              } else {
                return true;
              }
            });
          };

          const displayBooks = computed(() => {
            let localBooks = [];
            if (books) {
              localBooks = books;
              localBooks = searchBook(localBooks, keyword.value);
              localBooks = sortBook(localBooks, sortType.value);
            }
            return localBooks;
          });
          
          return {
            displayBooks,
            keyword,
            sortType,
          };
        },
        template: 
        `<div class="page">
          <div class="control">
            <div>
            <label>Search: </label>
            <input type="text" v-model="keyword" />
            </div>
          <div>
          <label>Sort: </label>
          <select v-model="sortType">
            <option value="" disabled selected>Choose...</option>
            <option value="asc">asc</option>
            <option value="desc">desc</option>
          </select>
          </div>
          </div>
          <ul class="list">
            <li v-for="book in displayBooks" key="book.id">
              {{ book.title }}
            </li>
          </ul>
        </div>`,
      };
      const app = Vue.createApp({
        components: {
          'list-book': ListBook,
        },
        template: 
        `<div>
          <list-book endpoint="http://localhost:5500/books.json" />
        </div>`,
      }).mount('#app');
    </script>
  </body>
</html>
